#!/usr/local/bin/node

"use strict";
const async = require("marcosc-async");
const fsp = require("fs-promise");
const pth = require("path");
const r = require("requirejs");

/**
 * Finds the name of the map file generated by Requirejs, and replaces it
 * with one that matches the filename of the ReSpec output file.
 *
 * @param  {String} respecJs The source for ReSpec, as produced by Requirejs.
 * @param  {String} outPath The path for the ReSpec source output file.
 * @return {Object} An object with a updated `source` and the new filename for
 *                  the map file.
 */

function replaceMapFilename(respecJs, outPath){
  // Capture group 1 is the name
  const findSourceMapName = /\/\/# sourceMappingURL=(.+)/gm;
  const basename = pth.basename(outPath, ".js");
  const newMapFilename = basename + ".build.js.map";
  let source;
  if(findSourceMapName.test(respecJs)){
    const currentMapFilename = respecJs.match(findSourceMapName)[1];
    source = respecJs.replace(currentMapFilename, newMapFilename);
  } else {
    source = respecJs;
  }
  const mapPath = pth.resolve(outPath, `../${newMapFilename}`);
  return {
    source,
    mapPath,
  };
}

 /**
 * Async function that appends the boilerplate to the generated script
 * and writes out the result. It also creates the source map file.
 *
 * @private
 * @param  {String} outPath Where to write the output to.
 * @param  {String} version The version of the script.
 * @return {Promise} Resolves when done writing the files.
 */
function writeOutput(outPath, version) {
  return async(function*(optimizedJs, sourceMap) {
    let newSource = replaceMapFilename(optimizedJs, outPath);
    const boilerplate = yield fsp.readFile("tools/inserts/boilerplate.frag", "utf-8");
    const finalSource = boilerplate
      .concat(newSource.source)
      .replace("<<ReSpec-Version-Number>>", version);
    const promiseToWriteJs = fsp.writeFile(outPath, finalSource, "utf-8");
    const promiseToWriteMap = fsp.writeFile(newSource.mapPath, sourceMap, "utf-8");
    yield Promise.all([promiseToWriteJs, promiseToWriteMap]);
  }, Builder);
}

var Builder = {
  /**
   * Async function that gets the current version of ReSpec from package.json
   *
   * @returns {Promise<String>} The version string.
   */
  getRespecVersion: async(function*() {
    const path = pth.join(__dirname, "../package.json");
    const content = yield fsp.readFile(path, "utf-8");
    return JSON.parse(content).version;
  }),

  /**
   * Async function runs Requirejs' optimizer to generate the output.
   *
   * using a custom configuration.
   * @param {Object} output The output options
   * @param {String} output.out The path where to write the optimized file.
   * @param {String} output.version The version number to use.
   */
  build(options) {
    return async.task(function*() {
      // optimisation settings
      const version = options.version || (yield this.getRespecVersion());
      const outputWritter = writeOutput(options.out, version);
      const config = {
        insertRequire: ["profile-w3c-common"],
        include: ["profile-w3c-common"],
        generateSourceMaps: true,
        mainConfigFile: "js/profile-w3c-common.js",
        baseUrl: pth.join(__dirname, "../js/"),
        optimize: options.optimize || "uglify2",
        paths: {
          "beautify": "../node_modules/js-beautify/js/lib/beautify",
          "beautify-css": "../node_modules/js-beautify/js/lib/beautify-css",
          "beautify-html": "../node_modules/js-beautify/js/lib/beautify-html",
          "fetch": "../node_modules/whatwg-fetch/fetch",
          "handlebars": "../node_modules/handlebars/dist/handlebars",
          "highlight": "../node_modules/highlightjs/highlight.pack.min",
          "highlightStyles": "../node_modules/highlightjs/styles/",
          "jquery": "../node_modules/jquery/dist/jquery",
          "marked": "../node_modules/marked/lib/marked",
          "Promise": "../node_modules/promise-polyfill/promise",
          "webidl2": "../node_modules/webidl2/lib/webidl2",
        },
        name: "../node_modules/almond/almond",
        deps: [
          "core/jquery-enhanced",
          "fetch",
          "jquery",
          "Promise",
        ],
        inlineText: true,
        preserveLicenseComments: false,
        useStrict: true,
      };
      const promiseToWrite = new Promise((resolve, reject)=>{
        config.out = (optimizedJs, sourceMap) => {
          outputWritter(optimizedJs, sourceMap)
            .then(resolve)
            .catch(reject);
        };
      });
      r.optimize(config);
      yield promiseToWrite;
    }, this);
  },
};

exports.Builder = Builder;
